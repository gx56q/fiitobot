# Идеи

* Выводить список половинки группы
* Понимать сокращённые имена: Ваня, Саша, Лёня ← реальные примеры из логов бота
* Автокик из чата не ФИИТов?
* Случайный кофе?
* Фото игра?

# Документация

## Что где хранится

Все данные для бота хранятся в S3 хранилище в следующем виде:

1. data.json − список контактов, с основной инфой без деталей (класс Contact).
   Этот файл обновляется ТОЛЬКО при выполнении команды /reload.

2. contact-<contactId>.json − детали по этому контакту (класс ContactDetails).
   В частности все оценки, выгруженные из БРС.
   Когда понадобится, тут можно сохранять состояние диалога.
   Этот файл может обновляться когда угодно.
   В частности, каждый раз, когда чел из списка известных контактов пишет боту, он обновляет TgName, TgId и
   LastUpdateTime, в ContactDetails.
   В частности, команда /scores обновляет оценки из БРС.

3. for-moderation-<tgId>.jpeg и moderated-<tgId>.jpeg — фотка для модерации и отмодерированная.
   В качестве идентификатора тут tgId, по историческим причинам. Надо бы переделать на contactId,
   чтобы фотки переживали смену аккаунта в телеграме.

## Загрузка данных из внешних источников

Бот умеет загружать контакты из гугл-таблицы с помощью команды /reload − это его основной источник данных.
Есть несколько тонких моментов:

1. Сценарий "В таблице изменили TgUsername".
   Если у пользователя поменялся tgUsername в таблице, и оно не совпадает с именем,
   сохранённым в Details, то надо забыть TgId из Details и сохранить в Details новое tgUsername.

2. Сценарий "Автозаполнение TgId в таблице". Если у пользователя TgId == 0, то надо взять TgId из Details и записать в таблицу.

##  Как стоит переделать работу с контактами?

Сценарии работы с контактами:

1. Добавили нового человека, указали у него только Telegram.
2. Нашли ошибку и изменили телеграм у человека.
3. Чел поменял ник в телеге и хочет, чтобы его ник обновился, при первом запросе к боту.

Реализация:
У каждого поля в Contact указано, приоритет источника для значений: таблица, либо данные самого бота.
У полей Telegram и TgId, а также у всех полей, редактируемый через бота - приоритет - бот!
У остальных полей приоритет - таблица.

Команда /reload
1. Добавляет новые записи в бота, присваивает им идентификаторы, если их нет.
2. Все поля с приоритетом таблицы перезаписываются в боте.
3. Все поля с приоритетом бота перезаписываются в таблице.
4. Бот выводит информацию о том, у кого что обновил в боте или таблице. (показывает первые 20 изменившихся записей).
5. Форматирует все столбцы, с приоритетом бота серым цветом. Добавляет примечание в заголовок о том, что их редактировать можно только через бота.

Команда /update @tgName|tgId FieldName newValue
1. Доступна только админам.
2. Меняет значение поля в боте на новое.

Пользователь написал боту.
Если у него неизвестен TgId, то заполняем его в боте и обновляем данные в таблице.
Если у него изменился TgUsername, то обновляем его в боте и таблице.
Не храним их в Details.
